function inputDatabase(e,t,r){if("language"===t)var n="Country-Locations-"+r.replace("_","-");else var n="Country-Blocks-"+r;Papa.parse("../../geolite2/GeoLite2-"+n+".csv",{header:!0,download:!0,worker:!0,skipEmptyLines:!0,fastMode:!0,complete:function(n){var o=e.transaction([r],"readwrite").objectStore(r);for(var a in n.data){var i=n.data[a];if("language"===t)var s={geoname_id:i.geoname_id,continent_code:i.continent_code,continent_name:i.continent_name,country_iso_code:i.country_iso_code,country_name:i.country_name};else if("ipv4"===t)var c=i.network.split("/"),u=c[1],d=c[0],g=IpSubnetCalculator.calculateSubnetMask(d,u),s={min_ip:g.ipLow,max_ip:g.ipHigh,geoname_id:i.geoname_id};else{network=i.network.split("/");var s={ip:network[0],prefix:network[1],geoname_id:i.geoname_id}}var l=o.add(s)}}})}function getHost(e){var t;return t=e.indexOf("://")>-1?e.split("/")[2]:e.split("/")[0],t=t.split(":")[0]}function showFlag(e,t){chrome.pageAction.setIcon({tabId:e,path:"../../img/flags/"+currentCodeList[t]+".png"}),chrome.pageAction.show(e);var r=currentCountryList[t]+"\n";currentIPList[t]!==t&&(r+=t+"\n"),r+=currentIPList[t],chrome.pageAction.setTitle({tabId:e,title:r})}function fileExists(e){var t=new XMLHttpRequest;t.open("HEAD",e,!0),t.onload=function(e){return!0},t.onerror=function(e){return!1},t.send()}function ipv4ToNumber(e){var t=e.split(".");return 256*(256*(256*+t[0]+ +t[1])+ +t[2])+ +t[3]}var request=indexedDB.open("GeoFlag",201504);const languages=["de","en","es","fr","ja","pt_BR","ru","zh_CN"];request.onerror=function(e){e.target.errorCode?alert("GeoFlag database error code "+e.target.errorCode+"."):alert("GeoFlag database error.")},request.onupgradeneeded=function(e){var t=e.target.result;if(0===e.oldVersion){var r=t.createObjectStore("IPv4",{keyPath:"min_ip"}),n=t.createObjectStore("IPv6",{keyPath:"ip"}),o=t.createObjectStore("de",{keyPath:"geoname_id"}),a=t.createObjectStore("en",{keyPath:"geoname_id"}),i=t.createObjectStore("es",{keyPath:"geoname_id"}),s=t.createObjectStore("fr",{keyPath:"geoname_id"}),c=t.createObjectStore("ja",{keyPath:"geoname_id"}),u=t.createObjectStore("pt_BR",{keyPath:"geoname_id"}),d=t.createObjectStore("ru",{keyPath:"geoname_id"}),g=t.createObjectStore("zh_CN",{keyPath:"geoname_id"});request.onsuccess=function(e){for(var r in languages)inputDatabase(t,"language",languages[r]);var n=["IPv6"];for(var r in n)inputDatabase(t,"addresses",n[r]);inputDatabase(t,"ipv4","IPv4")}}};var currentIPList={},currentCountryList={},currentCodeList={};chrome.extension.onMessage.addListener(function(e,t,r){switch(e.type){case"getIP":var n=e.url;r(void 0!==currentIPList[getHost(n)]?{domainToIP:currentIPList[getHost(n)],domainToCountry:currentCountryList[getHost(n)]}:{domainToIP:"Unknown",domainToCountry:"Unknown"});break;default:r({})}}),chrome.webRequest.onResponseStarted.addListener(function(e){var t=e.ip,r=getHost(e.url);if(ipaddr.isValid(t)&&(t!==currentIPList[r]&&(currentIPList[r]=t,currentCountryList[r]=void 0),!currentCountryList[r])){if(ipaddr.IPv4.isValid(t))var n="IPv4",o=ipv4ToNumber(t);else var n="IPv6",o=ipv6ToNumber(t);var a=indexedDB.open("GeoFlag",201504);a.onsuccess=function(t){var a=t.target.result,i=a.transaction([n],"readonly").objectStore(n);i.openCursor().onsuccess=function(t){var n=t.target.result;if(n)if(o>=n.value.min_ip&o<=n.value.max_ip){geoname_id=n.value.geoname_id;var a=chrome.i18n.getUILanguage();if(languages[a])var i=a;else var i="en";var s=indexedDB.open("GeoFlag",201504);s.onsuccess=function(t){var n=t.target.result,o=n.transaction([i],"readonly").objectStore(i);o.get(geoname_id).onsuccess=function(t){var n=t.target.result;null!==n&&(n.country_iso_code?(currentCodeList[r]=n.country_iso_code.toLowerCase(),currentCountryList[r]=n.country_name.replace(/"/g,"")):(currentCodeList[r]=n.continent_code.toLowerCase(),currentCountryList[r]=n.continent_name.replace(/"/g,"")),showFlag(e.tabId,r))}}}else n["continue"]()}}}},{urls:["<all_urls>"],types:["main_frame"]},[]),chrome.tabs.onUpdated.addListener(function(e,t,r){chrome.runtime.lastError||"undefined"==typeof currentCodeList[getHost(r.url)]||showFlag(e,getHost(r.url))});