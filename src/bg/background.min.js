function getHost(t){var e;return e=t.indexOf("://")>-1?t.split("/")[2]:t.split("/")[0],e=e.split(":")[0]}function showFlag(t,e){chrome.pageAction.setIcon({tabId:t,path:"../../img/flags/"+currentCodeList[e]+".png"}),chrome.pageAction.show(t);var r=currentCountryList[e]+"\n";currentIPList[e]!==e&&(r+=e+"\n"),r+=currentIPList[e],chrome.pageAction.setTitle({tabId:t,title:r})}function fileExists(t){try{var e=new XMLHttpRequest;return e.open("HEAD",t,!1),e.send(),!0}catch(r){return!1}}var currentIPList={},currentCountryList={},currentCodeList={};chrome.extension.onMessage.addListener(function(t,e,r){switch(t.type){case"getIP":var o=t.url;r(void 0!==currentIPList[getHost(o)]?{domainToIP:currentIPList[getHost(o)],domainToCountry:currentCountryList[getHost(o)]}:{domainToIP:"Unknown",domainToCountry:"Unknown"});break;default:r({})}}),chrome.webRequest.onResponseStarted.addListener(function(t){var e=t.ip,r=getHost(t.url);if(ipaddr.isValid(e)&&(e!==currentIPList[r]&&(currentIPList[r]=e,currentCountryList[r]=void 0),!currentCountryList[r])){if(ipaddr.IPv4.isValid(e))var o="GeoLite2-Country-Blocks-IPv4.csv";else var o="GeoLite2-Country-Blocks-IPv6.csv";Papa.parse("../../geolite2/"+o,{header:!0,download:!0,worker:!0,skipEmptyLines:!0,fastMode:!0,complete:function(o){var n=ipaddr.parse(e);o.data.forEach(function(e){var o=e.network.split("/"),i=ipaddr.parse(o[0]);if(n.match(i,o[1])){var s=e.geoname_id,a=chrome.i18n.getUILanguage().replace("_","-");if(fileExists("../../geolite2/GeoLite2-Country-Locations-"+a+".csv"))var c=a;else var c="en";Papa.parse("../../geolite2/GeoLite2-Country-Locations-"+c+".csv",{header:!0,download:!0,worker:!0,skipEmptyLines:!0,fastMode:!0,complete:function(e){e.data.forEach(function(e){e.geoname_id===s&&(e.country_iso_code?(currentCodeList[r]=e.country_iso_code.toLowerCase(),currentCountryList[r]=e.country_name.replace(/"/g,"")):(currentCodeList[r]=e.continent_code.toLowerCase(),currentCountryList[r]=e.continent_name.replace(/"/g,"")),showFlag(t.tabId,r))})}})}})}})}},{urls:["<all_urls>"],types:["main_frame"]},[]),chrome.tabs.onUpdated.addListener(function(t,e,r){chrome.runtime.lastError||"undefined"==typeof currentCodeList[getHost(r.url)]||showFlag(t,getHost(r.url))});